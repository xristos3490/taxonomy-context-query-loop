(()=>{"use strict";const e=window.React,t=window.wp.element,n=window.wp.blockEditor,o=window.wp.components,r=window.wp.hooks,s=window.wp.i18n,a=window.wp.data,l=window.wp.coreData,u=window.wp.compose,c=window.wp.htmlEntities,i=[],d=999999999999999,m=(0,s.__)("Same as viewed","tax-context-query-loop"),p={order:"asc",_fields:"id,name",context:"view"},y=(e,t)=>{const n=t?.id||e?.find((e=>e.name===t))?.id;if(n)return n;const o=t.toLocaleLowerCase();return e?.find((e=>e.name.toLocaleLowerCase()===o))?.id};function w({onChange:n,query:o}){const{postType:r,taxQuery:s}=o,u=(e=>{const n=(0,a.useSelect)((t=>{const{getTaxonomies:n}=t(l.store);return n({type:e,per_page:-1})}),[e]);return(0,t.useMemo)((()=>n?.filter((({visibility:e})=>!!e?.publicly_queryable))),[n])})(r);return u&&0!==u.length?(0,e.createElement)(e.Fragment,null,u.map((t=>{const o=s?.[t.slug]||[];return(0,e.createElement)(g,{key:t.slug,taxonomy:t,termIds:o,onChange:e=>{n({taxQuery:{...s,[t.slug]:e}})}})}))):null}function g({taxonomy:n,termIds:r,onChange:s}){const[w,g]=(0,t.useState)(""),[h,f]=(0,t.useState)(i),[x,E]=(0,t.useState)(i),v=(0,u.useDebounce)(g,250),{searchResults:b,searchHasResolved:q}=(0,a.useSelect)((e=>{if(!w)return{searchResults:i,searchHasResolved:!0};const{getEntityRecords:t,hasFinishedResolution:o}=e(l.store),s=["taxonomy",n.slug,{...p,search:w,orderby:"name",exclude:r,per_page:20}];return{searchResults:t(...s),searchHasResolved:o("getEntityRecords",s)}}),[w,r,n.slug]),_=(0,a.useSelect)((e=>{if(!r?.length)return i;const{getEntityRecords:t}=e(l.store),o=r.includes(d),s=o?r.filter((e=>e!==d)):r,a=t("taxonomy",n.slug,{...p,include:s,per_page:r.length});return o?(a||[]).concat({id:d,value:m}):a}),[r,n.slug]);return(0,t.useEffect)((()=>{if(r?.length||f(i),!_?.length)return;const e=r.reduce(((e,t)=>{if(t===d)return e.push({id:d,value:m}),e;const n=_.find((e=>e.id===t));return n&&e.push({id:t,value:n.name}),e}),[]);f(e)}),[r,_]),(0,t.useEffect)((()=>{if(!q)return;const e=(b?.map((e=>e.name))||[]).concat(m);E(e)}),[b,q]),(0,e.createElement)("div",{className:"block-library-query-inspector__taxonomy-control"},(0,e.createElement)(o.FormTokenField,{label:n.name,value:h,onInputChange:v,suggestions:x,displayTransform:c.decodeEntities,onChange:e=>{const t=new Set;for(const n of e)if(n===m)t.add(d);else{const e=y(b,n);e&&t.add(e)}E([m]),s(Array.from(t))},__experimentalExpandOnFocus:!0}))}(0,r.addFilter)("editor.BlockEdit","core/query",(r=>a=>{var l;const{attributes:u,setAttributes:c}=a;if("tax-context-query-loop/query-loop"!==u?.namespace||"post"!==u.query.postType)return(0,e.createElement)(r,{key:"edit",...a});const i=null!==(l=u.query.taxQuery)&&void 0!==l?l:{},m=(0,t.useMemo)((()=>!!i&&(0!==Object.keys(i).length&&Object.values(i).reduce(((e,t)=>(t.includes(d)&&(e=!0),e)),!1))),[i]);return(0,e.createElement)(e.Fragment,null,(0,e.createElement)(r,{key:"edit",...a}),(0,e.createElement)(n.InspectorControls,null,(0,e.createElement)(o.PanelBody,{title:(0,s.__)("Taxonomies","tax-context-query-loop"),initialOpen:!0},(0,e.createElement)(w,{onChange:e=>c({query:{...u.query,...e}}),query:u.query}),m&&(0,e.createElement)(o.PanelRow,null,(0,e.createElement)(o.Notice,{status:"info",isDismissible:!1},(0,s.__)("The products seen by shoppers will vary depending on the viewed product.","tax-context-query-loop"))))))}))})();